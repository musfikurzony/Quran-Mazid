<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚â° Qur'an ‚Ä¢ Word-by-Word ‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π</title>
<style>
  :root{
    --bg:#071014;
    --panel:#0f1720;
    --muted:#93a6b1;
    --text:#e6eef0;
    --accent:#22c55e;
    --accent-2:#f59e0b;
    --card:#08121a;
    --glass: rgba(255,255,255,0.03);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "Noto Sans Bengali", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";background:linear-gradient(180deg,#02040a 0%,var(--bg) 50%);color:var(--text);}
  a{color:inherit}
  /* Top bar (app) */
  .topbar{
    position:sticky;top:0;z-index:60;
    background:linear-gradient(90deg, rgba(2,6,10,0.7), rgba(4,20,12,0.7));
    border-bottom:1px solid rgba(255,255,255,0.03);
    padding:8px 12px;backdrop-filter: blur(6px);
    display:flex;align-items:center;gap:12px;
  }
  .hambtn{background:transparent;border:none;color:var(--text);font-size:20px;padding:6px;border-radius:8px;cursor:pointer;}
  .app-title{display:flex;flex-direction:column;line-height:1}
  .app-title h1{font-size:14px;margin:0;font-weight:700}
  .app-title small{font-size:11px;color:var(--muted)}
  .top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .icon-btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.1));border:1px solid rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;color:var(--text);cursor:pointer}
  .icon-btn.primary{background:linear-gradient(180deg, rgba(34,197,94,0.12), rgba(2,44,34,0.4));border-color:rgba(34,197,94,0.4)}
  /* layout */
  .layout{max-width:1100px;margin:12px auto;padding:8px;display:grid;grid-template-columns:260px 1fr;gap:12px}
  @media (max-width:880px){.layout{grid-template-columns:1fr} .leftpanel{order:2}.reader{order:1}}
  .leftpanel{background:linear-gradient(180deg,var(--panel), #08121a);border-radius:var(--radius);padding:12px;border:1px solid rgba(255,255,255,0.03);min-height:200px}
  .panel-title{font-weight:700;margin-bottom:8px;font-size:13px}
  .sura-search{position:relative}
  .sura-search input{width:100%;padding:8px 32px 8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  .sura-search .icon{position:absolute;right:10px;top:8px;color:var(--muted)}
  .sura-list{margin-top:10px;max-height:320px;overflow:auto}
  .sura-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
  .sura-item:hover{background:rgba(255,255,255,0.02)}
  .sura-item.active{background:linear-gradient(90deg, rgba(34,197,94,0.08), rgba(245,158,11,0.04));border:1px solid rgba(255,255,255,0.02)}
  .sura-name{font-weight:600}
  .sura-meta{font-size:12px;color:var(--muted)}
  .left-section{margin-top:12px}
  .mini-list{max-height:160px;overflow:auto;margin-top:6px}
  .mini-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:6px}
  .small-btn{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer}
  /* Reader */
  .reader{background:linear-gradient(180deg,#071216,#041018);border-radius:var(--radius);padding:10px;border:1px solid rgba(255,255,255,0.03);min-height:60vh}
  .surabar{display:flex;align-items:center;gap:12px;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.02);position:relative}
  .surabar .name{font-weight:700;font-size:16px}
  .surabar .meta{font-size:13px;color:var(--muted)}
  .surabar .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .surabar .controls .view-btn{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer}
  .aya-list{margin-top:10px;max-height:calc(100vh - 240px);overflow:auto;padding-right:6px}
  .aya-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:12px;padding:10px;margin-bottom:10px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:start}
  .aya-left{display:flex;align-items:flex-start;gap:6px}
  .aya-checkbox{margin-top:4px}
  .aya-number{font-size:12px;color:var(--muted);background:rgba(255,255,255,0.02);padding:6px;border-radius:6px}
  .aya-content{min-width:0}
  .aya-ar{font-family:"Scheherazade New","Amiri",serif;font-size:var(--arabic-size,22px);line-height:var(--arabic-lh,1.8);text-align:right;direction:rtl;color:var(--text);margin-bottom:6px}
  .aya-bn{font-size:var(--bangla-size,14px);color:var(--muted);margin-bottom:6px}
  .aya-trans-writers{font-size:13px;color:var(--muted);margin-bottom:6px}
  .aya-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .icon-chip{background:#071217;border-radius:999px;padding:6px 8px;border:1px solid rgba(255,255,255,0.03);color:var(--text);cursor:pointer}
  .icon-chip.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#022;box-shadow:0 6px 18px rgba(2,6,10,0.6)}
  .meta-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .three-dot{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:4px;border-radius:6px}
  .pill{background:rgba(255,255,255,0.02);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
  /* word tokens */
  .word-token{display:inline-block;padding:4px 8px;margin:4px 4px;border-radius:6px;border:1px solid transparent;cursor:pointer;transition:all .12s ease;font-size:var(--word-ar-size,20px)}
  .word-token:hover{background:rgba(34,197,94,0.06);border-color:rgba(34,197,94,0.14)}
  .word-token.active{background:linear-gradient(90deg, rgba(34,197,94,0.12), rgba(245,158,11,0.06));border-color:rgba(34,197,94,0.3)}
  /* bottom popup for word */
  .word-popup-backdrop{position:fixed;left:0;right:0;bottom:0;z-index:80;display:none;justify-content:center;padding:12px}
  .word-popup{width:min(980px,96%);background:linear-gradient(180deg,#09121a,#07101a);border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:10px;display:flex;gap:12px;align-items:flex-start;box-shadow:0 18px 45px rgba(0,0,0,0.6)}
  .word-popup .left{flex:0 0 34%}
  .word-popup .right{flex:1}
  .word-popup .arabic-word{font-family:"Scheherazade New","Amiri",serif;font-size:var(--popup-ar-size,28px);text-align:right}
  .word-popup .bn-mean{font-size:var(--popup-bn-size,15px);color:var(--text);margin-top:6px}
  .word-popup .notes{font-size:var(--popup-notes-size,13px);color:var(--muted);margin-top:8px;max-height:220px;overflow:auto}
  .word-popup .close-btn{margin-left:auto;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--muted);cursor:pointer}
  /* settings modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,8,0.62);display:none;align-items:center;justify-content:center;z-index:90;padding:20px}
  .modal{width:min(980px,98%);max-height:92vh;background:linear-gradient(180deg,#071216,#08121a);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);overflow:auto;color:var(--text)}
  .modal h3{margin:0 0 8px;font-size:16px}
  .setting-row{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .setting-row label{flex:0 0 240px;color:var(--muted);font-size:13px}
  .setting-row .control{flex:1}
  .slider{width:100%}
  .small{font-size:12px;color:var(--muted)}
  /* multi-select bar */
  .multi-bar{position:sticky;bottom:12px;display:none;align-items:center;justify-content:space-between;padding:10px;background:linear-gradient(90deg,#021010,#041018);border-radius:12px;border:1px solid rgba(255,255,255,0.03);z-index:70}
  .multi-bar.show{display:flex}
  .floating-settings{position:fixed;right:14px;bottom:16px;z-index:70}
  .floating-settings button{background:linear-gradient(90deg,#022  , #022);border:none;color:var(--text);padding:10px;border-radius:999px;cursor:pointer}
  /* responsive tweaks */
  @media (max-width:720px){
    .word-popup{flex-direction:column;left:10px;right:10px}
    .word-popup .left{flex:0 0 auto;width:100%}
    .layout{padding:8px}
    .aya-card{grid-template-columns:1fr;row-gap:8px}
    .surabar .controls{display:none}
    .leftpanel{display:none}
    .hambtn{display:inline-flex}
  }
  /* full-screen hide topbar */
  .hide-topbar .topbar{transform:translateY(-100%);transition:transform .28s ease}
</style>
</head>
<body>
  <div class="topbar" id="topbar">
    <button class="hambtn" id="hambBtn" title="Menu">‚ò∞</button>
    <div class="app-title">
      <h1>‚â° Qur'an ‚Ä¢ Word-by-Word</h1>
      <small>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π ‚Äî ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßá ‡¶∂‡¶¨‡ßç‡¶¶‡ßá-‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</small>
    </div>
    <div class="top-actions">
      <button id="openPinsBtn" class="icon-btn" title="Pins & Favourites">üìå ‡¶™‡¶ø‡¶®/‡¶´‡ßá‡¶≠</button>
      <button id="openSettingsBtn" class="icon-btn" title="Settings">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
      <button id="openSuraModalBtn" class="icon-btn primary" title="Full Surah list">üìñ ‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</button>
    </div>
  </div>

  <div class="layout" id="layoutRoot">
    <aside class="leftpanel" id="leftpanel">
      <div class="panel-title">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
      <div class="sura-search">
        <input id="suraSearch" placeholder="‡¶®‡¶æ‡¶Æ / ‡¶®‡¶Ç ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
        <span class="icon">üîé</span>
      </div>
      <div class="sura-list" id="suraList"></div>

      <div class="left-section">
        <div class="panel-title">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ</div>
        <div class="mini-list" id="lastReadBox">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶®‡ßá‡¶á</div>
      </div>

      <div class="left-section">
        <div class="panel-title">‡¶™‡¶ø‡¶® ‡¶ì ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü (‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø)</div>
        <div class="mini-list" id="leftPins"></div>
      </div>
    </aside>

    <main class="reader" id="reader">
      <div class="surabar" id="surabar">
        <div>
          <div class="name" id="currentSuraName">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
          <div class="meta" id="currentSuraMeta">‚Äî</div>
        </div>

        <div class="controls" id="suraControls">
          <div class="view-controls">
            <button class="view-btn" data-view="both">‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
            <button class="view-btn" data-view="ar">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</button>
            <button class="view-btn" data-view="bn">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
          </div>
          <button class="icon-btn" id="toggleFullScreen">üñ•Ô∏è ‡¶´‡ßÅ‡¶≤‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßÄ‡¶®</button>
        </div>
      </div>

      <div class="aya-list" id="ayaList" role="list"></div>

      <!-- multi-select bottom bar -->
      <div class="multi-bar" id="multiBar">
        <div id="multiCount">0 ayaat selected</div>
        <div style="display:flex;gap:8px">
          <button class="small-btn" id="multiCopyBtn">üìã ‡¶ï‡¶™‡¶ø</button>
          <button class="small-btn" id="multiShareBtn">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
          <button class="small-btn" id="multiClearBtn">‚úñ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Word popup -->
  <div class="word-popup-backdrop" id="wordPopupBackdrop" aria-hidden="true">
    <div class="word-popup" role="dialog" aria-modal="true" id="wordPopup">
      <div class="left">
        <div class="arabic-word" id="popupArabic"></div>
        <div class="bn-mean" id="popupMeaning"></div>
      </div>
      <div class="right">
        <button class="close-btn" id="popupClose">‚úï</button>
        <div class="notes" id="popupNotes"></div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="suraModal">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
        <button class="small-btn" data-close="suraModal">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>
      <div style="margin-top:10px">
        <input id="modalSuraSearch" placeholder="‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶æ‡¶Æ / ‡¶®‡¶Ç..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)">
      </div>
      <div id="modalSuraList" style="margin-top:10px;max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="settingsModal">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>‚öôÔ∏è ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ì ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
        <button class="small-btn" data-close="settingsModal">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>

      <div style="margin-top:10px">
        <!-- Writers -->
        <div class="setting-row">
          <label>‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶≤‡ßá‡¶ñ‡¶ï</label>
          <div class="control">
            <label style="margin-right:8px"><input type="checkbox" id="wOsmani" checked /> ‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ</label>
            <label><input type="checkbox" id="wTawjih" checked /> ‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®</label>
          </div>
        </div>

        <!-- Font sliders -->
        <div class="setting-row">
          <label>‡¶Ü‡¶∞‡¶¨‡¶ø (‡¶Ü‡ßü‡¶æ‡¶§) ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú <span id="arabicSizeVal" class="small"></span></label>
          <div class="control"><input id="arabicSize" class="slider" type="range" min="16" max="36" value="22" /></div>
        </div>

        <div class="setting-row">
          <label>‡¶Ü‡¶∞‡¶¨‡¶ø word (token) ‡¶∏‡¶æ‡¶á‡¶ú <span id="wordArSizeVal" class="small"></span></label>
          <div class="control"><input id="wordArSize" class="slider" type="range" min="14" max="34" value="20" /></div>
        </div>

        <div class="setting-row">
          <label>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶∏‡¶æ‡¶á‡¶ú <span id="banglaSizeVal" class="small"></span></label>
          <div class="control"><input id="banglaSize" class="slider" type="range" min="12" max="24" value="14" /></div>
        </div>

        <div class="setting-row">
          <label>‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ ‡¶∏‡¶æ‡¶á‡¶ú <span id="osmaniSizeVal" class="small"></span></label>
          <div class="control"><input id="osmaniSize" class="slider" type="range" min="12" max="22" value="13" /></div>
        </div>

        <div class="setting-row">
          <label>‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶∏‡¶æ‡¶á‡¶ú <span id="tawjihSizeVal" class="small"></span></label>
          <div class="control"><input id="tawjihSize" class="slider" type="range" min="12" max="22" value="13" /></div>
        </div>

        <div class="setting-row">
          <label>Word meaning (popup) ‡¶∏‡¶æ‡¶á‡¶ú <span id="popupBnVal" class="small"></span></label>
          <div class="control"><input id="popupBnSize" class="slider" type="range" min="12" max="20" value="15" /></div>
        </div>

        <div class="setting-row">
          <label>Grammar notes ‡¶∏‡¶æ‡¶á‡¶ú <span id="popupNotesVal" class="small"></span></label>
          <div class="control"><input id="popupNotesSize" class="slider" type="range" min="12" max="18" value="13" /></div>
        </div>

        <div class="setting-row">
          <label>‡¶≤‡¶æ‡¶á‡¶® ‡¶π‡¶æ‡¶á‡¶ü</label>
          <div class="control">
            <select id="lineHeight">
              <option value="1.6">Comfort (1.6)</option>
              <option value="1.8" selected>Relax (1.8)</option>
              <option value="2.0">Extra (2.0)</option>
            </select>
          </div>
        </div>

        <div class="setting-row">
          <label>‡¶´‡ßÅ‡¶≤-‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç (‡¶ü‡¶™‡¶¨‡¶æ‡¶∞ ‡¶π‡¶æ‡¶á‡¶°)</label>
          <div class="control">
            <label><input type="checkbox" id="fullScreenToggle" /> Enable</label>
          </div>
        </div>

        <div class="setting-row">
          <label>‡¶•‡¶ø‡¶Æ</label>
          <div class="control">
            <select id="themeSelect">
              <option value="dark" selected>Dark (default)</option>
              <option value="light">Light</option>
            </select>
          </div>
        </div>

      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="small-btn" id="resetSettingsBtn">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
        <button class="small-btn" data-close="settingsModal">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>
    </div>
  </div>

  <!-- Pins modal -->
  <div class="modal-backdrop" id="pinsModal">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>üìå ‡¶™‡¶ø‡¶® & ‚≠ê ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</h3>
        <button class="small-btn" data-close="pinsModal">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <div class="pill">‡¶™‡¶ø‡¶®: <span id="pinsCount">0</span></div>
        <div class="pill">‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü: <span id="favsCount">0</span></div>
        <div style="margin-left:auto">
          <button class="small-btn" id="clearAllPinsBtn" style="background:#2b0410;color:#fca5a5">‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px">
          <button class="small-btn" data-pinstab="pins" id="tabPins">üìå ‡¶™‡¶ø‡¶®</button>
          <button class="small-btn" data-pinstab="favs" id="tabFavs">‚≠ê ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</button>
        </div>

        <div id="pinsListContainer" style="margin-top:10px;max-height:56vh;overflow:auto"></div>
      </div>

    </div>
  </div>

<script src="suras.js"></script>
<script>
/* ========= State & helpers ========= */
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
let surasArr = (typeof suras !== 'undefined' && Array.isArray(suras)) ? suras : [];
// sura JSON will be fetched using s.file or s.fileName (common keys)
const el = id => document.getElementById(id);

const state = {
  curSuraIdx: 0,
  curSuraData: null,
  view: localStorage.getItem('q_view') || 'both',
  multiMode: false,
  selected: new Set(),
  pins: JSON.parse(localStorage.getItem('q_pins') || '[]'),
  favs: JSON.parse(localStorage.getItem('q_favs') || '[]'),
  lastRead: JSON.parse(localStorage.getItem('q_lastRead') || 'null'),
  settings: JSON.parse(localStorage.getItem('q_settings') || '{}')
};

/* default settings */
const defaultSettings = {
  arabicSize: 22, wordArSize:20, banglaSize:14,
  osmaniSize:13, tawjihSize:13, popupBnSize:15, popupNotesSize:13,
  lineHeight:1.8, showOsmani:true, showTawjih:true,
  theme:'dark', fullScreen:false
};
state.settings = Object.assign({}, defaultSettings, state.settings);

/* save helpers */
function savePins(){ localStorage.setItem('q_pins', JSON.stringify(state.pins)); }
function saveFavs(){ localStorage.setItem('q_favs', JSON.stringify(state.favs)); }
function saveLastRead(){ localStorage.setItem('q_lastRead', JSON.stringify(state.lastRead)); }
function saveSettings(){ localStorage.setItem('q_settings', JSON.stringify(state.settings)); }

/* ayah key helper */
function keyOf(sIdx,aIdx){ return `${sIdx}:${aIdx}` }

/* ======= UI Elements ======= */
const suraListEl = el('suraList');
const suraSearch = el('suraSearch');
const modalSura = el('suraModal');
const modalSuraList = el('modalSuraList');
const modalSuraSearch = el('modalSuraSearch');
const currentSuraName = el('currentSuraName');
const currentSuraMeta = el('currentSuraMeta');
const ayaListEl = el('ayaList');
const leftPinsEl = el('leftPins');
const lastReadBox = el('lastReadBox');
const multiBar = el('multiBar');
const multiCount = el('multiCount');
const pinsModal = el('pinsModal');
const pinsListContainer = el('pinsListContainer');
const pinsCountEl = el('pinsCount');
const favsCountEl = el('favsCount');
const wordPopupBackdrop = el('wordPopupBackdrop');
const popupArabic = el('popupArabic');
const popupMeaning = el('popupMeaning');
const popupNotes = el('popupNotes');
const popupClose = el('popupClose');
const topbar = el('topbar');

/* settings controls */
const settingsModal = el('settingsModal');
const arabicSize = el('arabicSize');
const wordArSize = el('wordArSize');
const banglaSize = el('banglaSize');
const osmaniSize = el('osmaniSize');
const tawjihSize = el('tawjihSize');
const popupBnSize = el('popupBnSize');
const popupNotesSize = el('popupNotesSize');
const lineHeightSelect = el('lineHeight');
const wOsmani = el('wOsmani');
const wTawjih = el('wTawjih');
const fullScreenToggle = el('fullScreenToggle');
const themeSelect = el('themeSelect');
const resetSettingsBtn = el('resetSettingsBtn');
const openSettingsBtn = el('openSettingsBtn');

/* initialize UI values from settings */
function loadSettingsToUI(){
  arabicSize.value = state.settings.arabicSize;
  wordArSize.value = state.settings.wordArSize;
  banglaSize.value = state.settings.banglaSize;
  osmaniSize.value = state.settings.osmaniSize;
  tawjihSize.value = state.settings.tawjihSize;
  popupBnSize.value = state.settings.popupBnSize;
  popupNotesSize.value = state.settings.popupNotesSize;
  lineHeightSelect.value = state.settings.lineHeight;
  wOsmani.checked = !!state.settings.showOsmani;
  wTawjih.checked = !!state.settings.showTawjih;
  fullScreenToggle.checked = !!state.settings.fullScreen;
  themeSelect.value = state.settings.theme;
  reflectSettingLabels();
}
function reflectSettingLabels(){
  el('arabicSizeVal').textContent = arabicSize.value + 'px';
  el('wordArSizeVal').textContent = wordArSize.value + 'px';
  el('banglaSizeVal').textContent = banglaSize.value + 'px';
  el('osmaniSizeVal').textContent = osmaniSize.value + 'px';
  el('tawjihSizeVal').textContent = tawjihSize.value + 'px';
  el('popupBnVal').textContent = popupBnSize.value + 'px';
  el('popupNotesVal').textContent = popupNotesSize.value + 'px';
}

/* apply CSS variables for font sizes */
function applyFontSettings(){
  document.documentElement.style.setProperty('--arabic-size', state.settings.arabicSize + 'px');
  document.documentElement.style.setProperty('--word-ar-size', state.settings.wordArSize + 'px');
  document.documentElement.style.setProperty('--bangla-size', state.settings.banglaSize + 'px');
  document.documentElement.style.setProperty('--popup-ar-size', (state.settings.wordArSize+6)+'px');
  document.documentElement.style.setProperty('--popup-bn-size', state.settings.popupBnSize + 'px');
  document.documentElement.style.setProperty('--popup-notes-size', state.settings.popupNotesSize + 'px');
  document.documentElement.style.setProperty('--arabic-lh', state.settings.lineHeight);
  // theme
  if(state.settings.theme === 'light'){
    document.documentElement.style.setProperty('--bg','#f0f7fb');
    document.documentElement.style.setProperty('--panel','#ffffff');
    document.documentElement.style.setProperty('--card','#ffffff');
    document.documentElement.style.setProperty('--text','#0b1720');
    document.documentElement.style.setProperty('--muted','#475569');
  } else {
    document.documentElement.style.removeProperty('--bg');
    document.documentElement.style.removeProperty('--panel');
    document.documentElement.style.removeProperty('--card');
    document.documentElement.style.removeProperty('--text');
    document.documentElement.style.removeProperty('--muted');
  }
  // hide topbar
  if(state.settings.fullScreen) document.body.classList.add('hide-topbar');
  else document.body.classList.remove('hide-topbar');
}

/* ========== Render sura list ========== */
function renderSuraList(filter=''){
  filter = (filter||'').toString().trim().toLowerCase();
  suraListEl.innerHTML = '';
  surasArr.forEach((s, idx) => {
    const bn = s.nameBn || s.name_bn || s.name || '';
    const ar = s.nameAr || s.name_ar || '';
    const item = document.createElement('div');
    item.className = 'sura-item' + (idx === state.curSuraIdx ? ' active' : '');
    item.dataset.idx = idx;
    item.innerHTML = `<div>
        <div class="sura-name">${idx+1}. ${bn}</div>
        <div class="sura-meta">${s.ayahCount || (s.ayas? s.ayas.length : '?')} ‡¶Ü‡ßü‡¶æ‡¶§</div>
      </div>
      <div class="sura-ar">${ar}</div>`;
    if(!filter || bn.toLowerCase().includes(filter) || ar.toLowerCase().includes(filter) || String(idx+1)===filter) {
      item.addEventListener('click', ()=>{ setCurrentSura(idx); });
      suraListEl.appendChild(item);
    }
  });

  // modal list too
  modalSuraList.innerHTML = '';
  surasArr.forEach((s,idx)=>{
    const bn = s.nameBn || s.name || '';
    const ar = s.nameAr || s.name_ar || '';
    const d = document.createElement('div');
    d.className='sura-item';
    d.innerHTML = `<div><div class="sura-name">${idx+1}. ${bn}</div><div class="sura-meta">${s.ayahCount || (s.ayas? s.ayas.length:'?')} ‡¶Ü‡ßü‡¶æ‡¶§</div></div><div class="sura-ar">${ar}</div>`;
    d.addEventListener('click', ()=>{ setCurrentSura(idx); closeModal('suraModal'); });
    if(!filter || bn.toLowerCase().includes(filter) || ar.toLowerCase().includes(filter) || String(idx+1)===filter) modalSuraList.appendChild(d);
  });
}

/* ===== load sura JSON file ===== */
function loadSuraJson(suraMeta){
  // suraMeta may have file || fileName || filePath keys ‚Äî try common variations
  const file = suraMeta.file || suraMeta.fileName || suraMeta.path || suraMeta.file_path;
  if(!file) {
    // if sura object already contains ayahs inline:
    return Promise.resolve(suraMeta);
  }
  return fetch(file).then(r => {
    if(!r.ok) throw new Error('file fetch error');
    return r.json();
  }).catch(err => {
    console.error('sura load error', err);
    alert('‡¶∏‡ßÅ‡¶∞‡¶æ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: '+file);
    return null;
  });
}

/* ===== render current sura & ayat list ===== */
function setCurrentSura(idx){
  state.curSuraIdx = idx;
  const meta = surasArr[idx];
  if(!meta) return;
  // highlight active
  Array.from(document.querySelectorAll('.sura-item')).forEach(i=> i.classList.toggle('active', Number(i.dataset.idx) === idx));
  currentSuraName.textContent = `${idx+1}. ${meta.nameBn || meta.name || ''} (${meta.nameAr || meta.name_ar || ''})`;
  currentSuraMeta.textContent = `${meta.revelationPlace ? meta.revelationPlace : ''} ¬∑ ${meta.ayahCount || (meta.ayas ? meta.ayas.length : '?')} ‡¶Ü‡ßü‡¶æ‡¶§`;
  // load json if needed
  loadSuraJson(meta).then(data=>{
    if(!data) return;
    state.curSuraData = data;
    // if loaded file has metadata that may differ, adapt:
    if(!data.ayas && data.ayahs) data.ayas = data.ayahs;
    renderAyaList();
    // scroll to top of reader
    document.querySelector('.reader').scrollIntoView({behavior:'smooth',block:'start'});
  });
}

/* render ayat list */
function renderAyaList(){
  ayaListEl.innerHTML = '';
  const sura = state.curSuraData;
  if(!sura || !sura.ayahs) {
    ayaListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">‡¶è‡¶á ‡¶∏‡ßÇ‡¶∞‡¶æ‡¶∞ ayahs ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
    return;
  }
  const ayas = sura.ayahs;
  ayas.forEach((ayah, aIdx) => {
    const row = document.createElement('div');
    row.className = 'aya-card';
    row.id = `aya-${state.curSuraIdx}-${aIdx}`;

    // left: checkbox on multi-mode
    const left = document.createElement('div');
    left.className = 'aya-left';
    const chkWrap = document.createElement('div');
    chkWrap.className = 'aya-checkbox';
    if(state.multiMode){
      const cb = document.createElement('input');
      cb.type='checkbox';
      const k = keyOf(state.curSuraIdx,aIdx);
      cb.checked = state.selected.has(k);
      cb.addEventListener('change', ()=>{
        if(cb.checked) state.selected.add(k); else state.selected.delete(k);
        updateMultiBar();
      });
      chkWrap.appendChild(cb);
    } else {
      // show minimal dot to not take space: keep empty
      chkWrap.style.width = '18px';
    }
    const num = document.createElement('div');
    num.className = 'aya-number';
    num.textContent = `${state.curSuraIdx+1}:${aIdx+1}`;
    left.appendChild(chkWrap);
    left.appendChild(num);

    // center: content
    const content = document.createElement('div');
    content.className = 'aya-content';
    // meta row (top) with 3-dot menu above first word (placed here)
    const metaRow = document.createElement('div');
    metaRow.className = 'meta-row';
    const spanNum = document.createElement('div'); spanNum.className='pill'; spanNum.textContent = ` ${state.curSuraIdx+1}:${aIdx+1} `;
    metaRow.appendChild(spanNum);

    // actions short
    const actionsShort = document.createElement('div');
    actionsShort.style.marginLeft = '8px'; actionsShort.style.display='flex'; actionsShort.style.gap='8px';
    // pin status
    const isPinnedNow = state.pins.some(p => p.key === keyOf(state.curSuraIdx,aIdx));
    const pinBtn = document.createElement('button');
    pinBtn.className = 'icon-chip'; pinBtn.title = 'Pin';
    pinBtn.innerHTML = isPinnedNow ? 'üìå Pinned' : 'üìå Pin';
    pinBtn.addEventListener('click', ()=>{ togglePin(state.curSuraIdx,aIdx); renderAyaList(); renderSidePins(); renderPinsModal(); });
    actionsShort.appendChild(pinBtn);
    // fav
    const isFavNow = state.favs.some(p => p.key === keyOf(state.curSuraIdx,aIdx));
    const favBtn = document.createElement('button');
    favBtn.className = 'icon-chip'; favBtn.title = 'Favourite';
    favBtn.innerHTML = isFavNow ? '‚≠ê Fav' : '‚òÜ Fav';
    favBtn.addEventListener('click', ()=>{ toggleFav(state.curSuraIdx,aIdx); renderAyaList(); renderSidePins(); renderPinsModal(); });
    actionsShort.appendChild(favBtn);
    // last read
    const lastBtn = document.createElement('button'); lastBtn.className='icon-chip'; lastBtn.textContent='‚è± Last';
    lastBtn.addEventListener('click', ()=>{ state.lastRead = {suraIndex: state.curSuraIdx, ayaIndex: aIdx, time: Date.now()}; saveLastRead(); renderLastReadBox(); alert('‡¶è‡¶á ‡¶Ü‡ßü‡¶æ‡¶§‡¶ï‡ßá ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); });
    actionsShort.appendChild(lastBtn);
    // three dot menu
    const three = document.createElement('button'); three.className='three-dot'; three.innerHTML='‚ãØ';
    three.title = 'More';
    three.addEventListener('click', (ev)=>{ openAyahMenu(ev, state.curSuraIdx, aIdx, ayah); });
    metaRow.appendChild(actionsShort); metaRow.appendChild(three);

    // Arabic (word-by-word or full)
    const arDiv = document.createElement('div');
    arDiv.className = 'aya-ar';
    if(state.view === 'word' || (state.view==='both' && Array.isArray(ayah.words) && ayah.words.length>0)){
      // create tokens
      if(Array.isArray(ayah.words) && ayah.words.length>0){
        ayah.words.forEach((w, widx)=>{
          const t = document.createElement('span');
          t.className = 'word-token';
          t.textContent = w.text || w.word || '';
          t.dataset.widx = widx;
          t.addEventListener('click', ()=> openWordPopup(ayah, w, state.curSuraIdx, aIdx));
          arDiv.appendChild(t);
        });
      } else {
        arDiv.textContent = ayah.arabic || ayah.ar || ayah.text_ar || '';
      }
    } else {
      arDiv.textContent = ayah.arabic || ayah.ar || ayah.text_ar || '';
    }

    // Bangla main
    const bnDiv = document.createElement('div'); bnDiv.className='aya-bn';
    bnDiv.textContent = ayah.bangla || ayah.bn || ayah.text_bn || '';

    // writer translations
    const transDiv = document.createElement('div'); transDiv.className='aya-trans-writers';
    if(state.settings.showOsmani && ayah.translations && ayah.translations.osmani){ const d = document.createElement('div'); d.style.fontSize = state.settings.osmaniSize+'px'; d.innerHTML = `<span style="color:var(--accent)">[‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ]</span> ${ayah.translations.osmani}`; transDiv.appendChild(d); }
    if(state.settings.showTawjih && ayah.translations && ayah.translations.tawjih){ const d = document.createElement('div'); d.style.fontSize = state.settings.tawjihSize+'px'; d.innerHTML = `<span style="color:var(--accent-2)">[‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π]</span> ${ayah.translations.tawjih}`; transDiv.appendChild(d); }

    // append center
    content.appendChild(metaRow);
    // if view is 'ar' hide bn/trans appropriately
    if(state.view === 'ar'){
      content.appendChild(arDiv);
    } else if(state.view === 'bn'){
      content.appendChild(bnDiv);
      if(transDiv.childNodes.length) content.appendChild(transDiv);
    } else {
      content.appendChild(arDiv);
      if(bnDiv.textContent) content.appendChild(bnDiv);
      if(transDiv.childNodes.length) content.appendChild(transDiv);
    }

    // right: actions column (copy/share etc)
    const actionsCol = document.createElement('div'); actionsCol.className='aya-actions';
    const copyBtn = document.createElement('button'); copyBtn.className='icon-chip'; copyBtn.textContent='üìã'; copyBtn.title='Copy this ayah';
    copyBtn.addEventListener('click', ()=>{ const txt = formatAyahForCopy(state.curSuraIdx,aIdx); navigator.clipboard.writeText(txt).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá')); });
    const shareBtn = document.createElement('button'); shareBtn.className='icon-chip'; shareBtn.textContent='üîó';
    shareBtn.addEventListener('click', ()=>{ const txt = formatAyahForCopy(state.curSuraIdx,aIdx); shareText(txt); });
    actionsCol.appendChild(copyBtn); actionsCol.appendChild(shareBtn);

    // assemble
    row.appendChild(left);
    row.appendChild(content);
    row.appendChild(actionsCol);
    ayaListEl.appendChild(row);
  });

  // apply token font size and word token shape
  document.querySelectorAll('.word-token').forEach(el=>{
    el.style.fontSize = state.settings.wordArSize + 'px';
    el.style.borderRadius = '6px'; // square-ish
  });

  // update counters & side lists
  renderSidePins();
  updateMultiBar();
}

/* format ayah for copy */
function formatAyahForCopy(sIdx,aIdx, mode='both'){
  const s = surasArr[sIdx];
  const ay = (state.curSuraData && state.curSuraData.ayahs && state.curSuraData.ayahs[aIdx]) || {};
  const ar = ay.arabic || ay.ar || ay.text_ar || '';
  const bn = ay.bangla || ay.bn || ay.text_bn || '';
  const os = ay.translations && ay.translations.osmani || '';
  const ta = ay.translations && ay.translations.tawjih || '';
  const header = `[${sIdx+1}:${aIdx+1} - ${s.nameBn || s.name || ''}]`;
  let parts = [];
  if(mode==='both' || mode==='ar') parts.push(ar);
  if(mode==='both' || mode==='bn') parts.push(bn);
  if(state.settings.showOsmani && os) parts.push('[‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ] '+os);
  if(state.settings.showTawjih && ta) parts.push('[‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π] '+ta);
  parts.push(header);
  return parts.filter(Boolean).join('\n');
}

/* share helper */
function shareText(text){
  if(navigator.share){
    navigator.share({text}).catch(()=>{navigator.clipboard.writeText(text); alert('Share failed ‚Äî copied to clipboard.')});
  } else {
    navigator.clipboard.writeText(text).then(()=>alert('‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á ‚Äî ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
  }
}

/* open ayah 'three-dot' menu */
function openAyahMenu(ev, sIdx, aIdx, ayah){
  ev.stopPropagation();
  // small floating menu implemented as browser prompt-like for simplicity
  const menu = document.createElement('div');
  menu.style.position='absolute';
  menu.style.zIndex=120;
  menu.style.right='18px';
  menu.style.top=(ev.clientY)+'px';
  menu.style.background='linear-gradient(180deg,#051218,#07121a)';
  menu.style.border='1px solid rgba(255,255,255,0.03)';
  menu.style.padding='8px';
  menu.style.borderRadius='8px';
  menu.style.boxShadow='0 8px 26px rgba(0,0,0,0.6)';
  menu.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px">
    <button class="small-btn" id="m_multi">${ state.multiMode ? '‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®' }</button>
    <button class="small-btn" id="m_copy">üìã ‡¶ï‡¶™‡¶ø</button>
    <button class="small-btn" id="m_share">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
    <button class="small-btn" id="m_last">‚è± ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶∏‡ßá‡¶ü</button>
  </div>`;
  document.body.appendChild(menu);
  // handlers
  menu.querySelector('#m_multi').addEventListener('click', ()=>{
    toggleMultiMode();
    document.body.removeChild(menu);
  });
  menu.querySelector('#m_copy').addEventListener('click', ()=>{
    navigator.clipboard.writeText(formatAyahForCopy(sIdx,aIdx)).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
    document.body.removeChild(menu);
  });
  menu.querySelector('#m_share').addEventListener('click', ()=>{
    shareText(formatAyahForCopy(sIdx,aIdx));
    document.body.removeChild(menu);
  });
  menu.querySelector('#m_last').addEventListener('click', ()=>{
    state.lastRead = {suraIndex:sIdx, ayaIndex:aIdx, time: Date.now()};
    saveLastRead(); renderLastReadBox();
    alert('‡¶è‡¶á ‡¶Ü‡ßü‡¶æ‡¶§‡¶ï‡ßá ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    document.body.removeChild(menu);
  });
  // auto remove if click outside
  const rm = (ev2)=>{ if(!menu.contains(ev2.target)) { document.body.removeChild(menu); document.removeEventListener('click', rm); } };
  setTimeout(()=>document.addEventListener('click', rm), 10);
}

/* toggle multi mode */
function toggleMultiMode(on){
  state.multiMode = (typeof on === 'boolean') ? on : !state.multiMode;
  if(!state.multiMode) state.selected.clear();
  renderAyaList();
}

/* update multi bar */
function updateMultiBar(){
  const count = state.selected.size;
  if(count>0){
    multiBar.classList.add('show');
    multiCount.textContent = count + ' ‡¶ü‡¶ø ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§';
  } else {
    multiBar.classList.remove('show');
  }
}

/* handle multi actions */
el('multiCopyBtn').addEventListener('click', ()=>{
  if(state.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡ßá‡¶á');
  const arr = Array.from(state.selected).map(k => k.split(':').map(Number));
  arr.sort((a,b)=> a[0]-b[0] || a[1]-b[1]);
  const texts = arr.map(pair => formatAyahForCopy(pair[0],pair[1])).join('\n\n');
  el('copyPreview') && (el('copyPreview').value = texts);
  navigator.clipboard.writeText(texts).then(()=>alert('‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶ï‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
});
el('multiShareBtn').addEventListener('click', ()=>{
  if(state.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶®‡ßá‡¶á');
  const arr = Array.from(state.selected).map(k => k.split(':').map(Number));
  arr.sort((a,b)=> a[0]-b[0] || a[1]-b[1]);
  const texts = arr.map(pair => formatAyahForCopy(pair[0],pair[1])).join('\n\n');
  shareText(texts);
});
el('multiClearBtn').addEventListener('click', ()=>{ state.selected.clear(); toggleMultiMode(false); updateMultiBar(); });

/* Pin & fav helpers */
function togglePin(sIdx,aIdx){
  const k = keyOf(sIdx,aIdx);
  // For "last-pin" behaviour, ensure only one pin per folder "default" - replace older
  // We'll keep pins array but for "default-folder-last" we will ensure unique per folder.
  // For simplicity, treat pins as many, but also have "activePin" per folder concept
  const existing = state.pins.findIndex(p => p.key === k);
  if(existing >= 0){
    state.pins.splice(existing,1);
  } else {
    // remove other pins in folder 'default' that are flagged as folderLast (if exists), optional
    // For now only push new pin
    state.pins.unshift({ key:k, suraIndex:sIdx, ayaIndex:aIdx, folder:'default', time:Date.now(), note:'' });
  }
  savePins(); renderSidePins(); renderPinsModal();
}
function toggleFav(sIdx,aIdx){
  const k = keyOf(sIdx,aIdx);
  const existing = state.favs.findIndex(p => p.key === k);
  if(existing >= 0) state.favs.splice(existing,1);
  else state.favs.unshift({ key:k, suraIndex:sIdx, ayaIndex:aIdx, folder:'general', time:Date.now(), note:'' });
  saveFavs(); renderSidePins(); renderPinsModal();
}

/* render side pins & left panels */
function renderSidePins(){
  // leftPins
  leftPinsEl.innerHTML = '';
  const combined = [...state.pins.slice(0,6), ...state.favs.slice(0,6)];
  if(combined.length===0){
    leftPinsEl.innerHTML = `<div style="color:var(--muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶ø‡¶® / ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü ‡¶®‡ßá‡¶á</div>`;
  } else {
    combined.slice(0,8).forEach(item=>{
      const s = surasArr[item.suraIndex] || {};
      const ay = (s.ayas && s.ayas[item.ayaIndex]) || {};
      const wrap = document.createElement('div'); wrap.className='mini-item';
      wrap.innerHTML = `<div><strong>${item.suraIndex+1}:${item.ayaIndex+1}</strong><div style="font-size:12px;color:var(--muted)">${s.nameBn||s.name||''}</div></div>
        <div><button class="small-btn">‡¶Ø‡¶æ‡¶®</button></div>`;
      wrap.querySelector('button').addEventListener('click', ()=>{
        setCurrentSura(item.suraIndex);
        setTimeout(()=>{ const elm = document.getElementById('aya-'+item.suraIndex+'-'+item.ayaIndex); elm && elm.scrollIntoView({behavior:'smooth',block:'center'}); }, 120);
      });
      leftPinsEl.appendChild(wrap);
    });
  }
  pinsCountEl.textContent = state.pins.length;
  favsCountEl.textContent = state.favs.length;
}

/* render pins modal */
function renderPinsModal(tab='pins'){
  pinsListContainer.innerHTML = '';
  const list = (tab==='pins') ? state.pins : state.favs;
  if(!list.length) { pinsListContainer.innerHTML = `<div style="color:var(--muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</div>`; return; }
  list.forEach(item=>{
    const s = surasArr[item.suraIndex] || {};
    const ay = (s.ayas && s.ayas[item.ayaIndex]) || {};
    const row = document.createElement('div'); row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${item.suraIndex+1}:${item.ayaIndex+1}</strong> - ${s.nameBn||s.name||''} <div style="color:var(--muted);font-size:13px">${(ay.bangla||ay.bn||'').slice(0,90)}</div></div>
      <div style="display:flex;gap:6px"><button class="small-btn">‡¶Ø‡¶æ‡¶®</button><button class="small-btn">üìã</button><button class="small-btn" style="background:#2b0410;color:#fca5a5">‡¶°‡¶ø‡¶≤</button></div>
    </div>`;
    row.querySelectorAll('button')[0].addEventListener('click', ()=>{ setCurrentSura(item.suraIndex); closeModal('pinsModal'); setTimeout(()=>{ document.getElementById('aya-'+item.suraIndex+'-'+item.ayaIndex).scrollIntoView({behavior:'smooth',block:'center'}); },140); });
    row.querySelectorAll('button')[1].addEventListener('click', ()=>{ navigator.clipboard.writeText(formatAyahForCopy(item.suraIndex,item.ayaIndex)).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá')); });
    row.querySelectorAll('button')[2].addEventListener('click', ()=>{ if(tab==='pins') state.pins = state.pins.filter(p=>p.key!==item.key); else state.favs = state.favs.filter(p=>p.key!==item.key); savePins(); saveFavs(); renderPinsModal(tab); renderSidePins(); renderAyaList(); });
    pinsListContainer.appendChild(row);
  });
}

/* render last read */
function renderLastReadBox(){
  if(!state.lastRead){ lastReadBox.innerHTML = '<div style="color:var(--muted)">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶®‡ßá‡¶á</div>'; return; }
  const s = surasArr[state.lastRead.suraIndex] || {};
  const ay = (s.ayas && s.ayas[state.lastRead.ayaIndex]) || {};
  lastReadBox.innerHTML = `<div><strong>${state.lastRead.suraIndex+1}:${state.lastRead.ayaIndex+1}</strong> - ${s.nameBn||s.name||''}</div>
    <div style="color:var(--muted);margin-top:6px">${(ay.bangla||ay.bn||'').slice(0,120)}...</div>
    <div style="margin-top:8px;display:flex;gap:6px"><button class="small-btn" id="goLastBtn">‚è± ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button><button class="small-btn" id="clearLastBtn">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button></div>`;
  el('goLastBtn') && el('goLastBtn').addEventListener('click', ()=>{ setCurrentSura(state.lastRead.suraIndex); setTimeout(()=>{ document.getElementById('aya-'+state.lastRead.suraIndex+'-'+state.lastRead.ayaIndex).scrollIntoView({behavior:'smooth',block:'center'}); },120); });
  el('clearLastBtn') && el('clearLastBtn').addEventListener('click', ()=>{ state.lastRead=null; saveLastRead(); renderLastReadBox(); });
}

/* word popup */
function openWordPopup(ayah, wordObj, sIdx, aIdx){
  popupArabic.textContent = wordObj.text || wordObj.word || '';
  popupMeaning.textContent = wordObj.meaningBn || wordObj.meaning || wordObj.mean || '‚Äî';
  popupNotes.textContent = wordObj.notes || wordObj.note || '‚Äî';
  // show popup
  wordPopupBackdrop.style.display = 'flex';
  wordPopupBackdrop.scrollIntoView({behavior:'smooth'});
}
popupClose.addEventListener('click', ()=>{ wordPopupBackdrop.style.display='none'; });

/* modal open/close helpers */
function openModal(id){ el(id).style.display='flex'; el(id).classList.add('active'); }
function closeModal(id){ el(id).style.display='none'; el(id).classList.remove('active'); }

/* initial setup */
function init(){
  // load sura list
  renderSuraList();
  // set initial sura
  if(surasArr.length) setCurrentSura(0);
  // load settings UI
  loadSettingsToUI();
  applyFontSettings();
  renderSidePins();
  renderPinsModal();
  renderLastReadBox();
  // events
  suraSearch.addEventListener('input', ()=> renderSuraList(suraSearch.value));
  modalSuraSearch.addEventListener('input', ()=> renderSuraList(modalSuraSearch.value));
  el('openSuraModalBtn').addEventListener('click', ()=> openModal('suraModal'));
  Array.from(document.querySelectorAll('[data-close]')).forEach(btn=> btn.addEventListener('click', ()=> closeModal(btn.dataset.close)));
  el('openSettingsBtn').addEventListener('click', ()=> openModal('settingsModal'));
  el('openPinsBtn').addEventListener('click', ()=> { renderPinsModal(); openModal('pinsModal'); });
  el('openPinsBtn').addEventListener('click', ()=> openModal('pinsModal'));

  // settings change handlers
  [arabicSize, wordArSize, banglaSize, osmaniSize, tawjihSize, popupBnSize, popupNotesSize].forEach(inp=>{
    inp.addEventListener('input', ()=>{
      state.settings[inp.id] = Number(inp.value);
      reflectSettingLabels();
      saveSettings();
      applyFontSettings();
      renderAyaList();
    });
  });
  lineHeightSelect.addEventListener('change', ()=>{ state.settings.lineHeight = Number(lineHeightSelect.value); saveSettings(); applyFontSettings(); renderAyaList(); });
  wOsmani.addEventListener('change', ()=>{ state.settings.showOsmani = wOsmani.checked; saveSettings(); renderAyaList(); });
  wTawjih.addEventListener('change', ()=>{ state.settings.showTawjih = wTawjih.checked; saveSettings(); renderAyaList(); });
  fullScreenToggle.addEventListener('change', ()=>{ state.settings.fullScreen = fullScreenToggle.checked; saveSettings(); applyFontSettings(); });
  themeSelect.addEventListener('change', ()=>{ state.settings.theme = themeSelect.value; saveSettings(); applyFontSettings(); renderAyaList(); });
  resetSettingsBtn.addEventListener('click', ()=>{ state.settings = Object.assign({}, defaultSettings); saveSettings(); loadSettingsToUI(); applyFontSettings(); renderAyaList(); });

  // view toggles
  Array.from(document.querySelectorAll('.view-btn')).forEach(btn=>{
    btn.addEventListener('click', ()=>{ state.view = btn.dataset.view === 'both' ? 'both' : (btn.dataset.view==='ar'?'ar':'bn'); Array.from(document.querySelectorAll('.view-btn')).forEach(b=>b.classList.toggle('active', b===btn)); renderAyaList(); });
  });

  // sura modal close
  modalSura.querySelector('[data-close="suraModal"]').addEventListener('click', ()=> closeModal('suraModal'));

  // pins modal tabs
  el('tabPins').addEventListener('click', ()=>{ renderPinsModal('pins'); });
  el('tabFavs').addEventListener('click', ()=>{ renderPinsModal('favs'); });

  // clear all pins
  el('clearAllPinsBtn').addEventListener('click', ()=>{ if(confirm('‡¶∏‡¶¨ ‡¶™‡¶ø‡¶® ‡¶ì ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')){ state.pins=[]; state.favs=[]; savePins(); saveFavs(); renderPinsModal(); renderSidePins(); renderAyaList(); } });

  // multi bar close on scroll or outside
  document.addEventListener('click', (e)=>{ /* hide floating menus if any */ });

  // hamburger toggles leftpanel on mobile
  el('hambBtn').addEventListener('click', ()=>{ el('leftpanel').style.display = el('leftpanel').style.display === 'none' ? 'block' : 'none'; });

  // full-screen toggle button
  el('toggleFullScreen').addEventListener('click', ()=>{ state.settings.fullScreen = !state.settings.fullScreen; fullScreenToggle.checked = state.settings.fullScreen; saveSettings(); applyFontSettings(); });

  // multi-bar buttons
  // already wired above

  // keyboard support: ESC to close popups
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ wordPopupBackdrop.style.display='none'; closeModal('suraModal'); closeModal('settingsModal'); closeModal('pinsModal'); } });

  // initial reflect labels
  reflectSettingLabels();
}

/* run init after DOM */
document.addEventListener('DOMContentLoaded', ()=>{ init(); });

/* ===== utility: share/copy for single ayah from outside ===== */
function copyAyah(sIdx,aIdx){ navigator.clipboard.writeText(formatAyahForCopy(sIdx,aIdx)).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá')); }
function shareAyah(sIdx,aIdx){ shareText(formatAyahForCopy(sIdx,aIdx)); }

/* ===== expose small debug helpers to window ===== */
window.qapp = {
  setCurrentSura, setState: (k,v)=>{ state[k]=v; }, getState: ()=>state, copyAyah, shareAyah
};

</script>
</body>
</html>
